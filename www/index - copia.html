<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" manifest="/m?manifest=1">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Ghosts hunters</title>
    <meta name="viewport" content="target-densitydpi=medium-dpi,width=device-width,initial-scale=1,user-scalable=no" />
    <script src="utils.js" type="text/javascript"></script>    
    <script src="jq.js" type="text/javascript"></script>   
    <style>
        body,p,td,font,div,span
        {
        	
        	color:White;
        	font-family:Verdana;
        	font-weight:bold;
        	font-size:12px;
        }
        body{
          background-color:black;
        }
        img
        {
        	text-align:center;
        	border:0px;
        }
        div
        {
        	width:300px;
        	text-align:center;
        }
        /* Debugging output */
        
    </style>
    
    <script>
      var ctx;
      var ctxBG;
      var timeraux = null;
      var clockspeed = 50;
      var pause = false;
      var waiting = false;
      var factorw = 720 / 300
      var factorh = 960 / 350
      var canvasw = 300*factorw;
      var canvash = 350*factorh;
      var ratiow = 0.5
      var ratioh = 0.5
      var rangey = 55;
      var bswitch = 0;
      var ML=new MediaLibrary();
      var mouse = { x: 0, y: 0, antx: 0, anty: 0 }
      var ghost = { xPos: 150, yPos: 4, dx: 0, dy: 0, w: 45 * factorw, h: 55 * factorh, tox: 150, toy: 4, movesteps: 0, incx: 0, incy: 0 }
      var trap = { xPos: 1, yPos: 295 * factorh, w: 45 * factorw, h: 55 * factorh, despx: 1, estado: 1, contestado: 0, tipo: 0 }
      var pajaro = { xPos: 150, yPos: 4, dx: 0, dy: 0, w: 60 * factorw, h: 60 * factorh, tox: 150, toy: 4, movesteps: 20, incx: 0, incy: 0 }
      var contclick = 0;
      var breaklockx = 0;
      var breaklockdesp = 3;
      var gamestatus = 0 //0 libre,1 capturado,2 pregana,3 prepierde, 5 capturado(colocar los munecos),6 gana,7 pierde,8 break lock,9 toca pajaro,10 showmsg;
      var gamestatuscont = 0 //de momento no se usa
      var fuel = 200;
      //var gravity = .0005;
      var gravity = .06;
      var lander = null;
      var landerHeight = 0;
      var landerWidth = 0;
      var timerkey = null;
      var ticker=new MessageTicker();
      var anims = new Array(6);
      var cont = 0;
      anims[cont++] = { src: 'aghost', numframes: 2, cont: 0, max: 4, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'aghosta', numframes: 2, cont: 0, max: 4, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'aplayer', numframes: 2, cont: 0, max: 4, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'bola', numframes: 4, cont: 0, max: 2, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'explo', numframes: 6, cont: 0, max: 2, current: 0, numrepes: 1 }
      anims[cont++] = { src: 'donde', numframes: 2, cont: 0, max: 2, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'pajaro', numframes: 2, cont: 0, max: 2, current: 0, numrepes: 0 }
      anims[cont++] = { src: 'trapon', numframes: 2, cont: 0, max: 1, current: 0, numrepes: 0 }

      var levels = new Array(30);
      cont = 0;
      levels[cont++] = { tipoghost: 0, numpajaros: 1, bg: 'f1.jpg', txt: 'La Alhambra de Granada', fuel: 200, traptipo: 0, speed: 2 };
      levels[cont++] = { tipoghost: 0, numpajaros: 1, bg: 'f1.jpg', txt: 'La Alhambra de Granada', fuel: 200, traptipo: 0, speed: 2 };
      levels[cont++] = { tipoghost: 1, numpajaros: 1, bg: 'f2.jpg', txt: 'Angkor', fuel: 200, traptipo: 0, speed: 2 };
      levels[cont++] = { tipoghost: 0, numpajaros: 2, bg: 'f2.jpg', txt: 'Angkor', fuel: 200, traptipo: 1, speed: 2 };
      levels[cont++] = { tipoghost: 0, numpajaros: 2, bg: 'f2.jpg', txt: 'Angkor', fuel: 200, traptipo: 0, speed: 2 };
      levels[cont++] = { tipoghost: 1, numpajaros: 2, bg: 'f4.jpg', txt: 'Neuschwanstein Castle', fuel: 200, traptipo: 0, speed: 2 };
      levels[cont++] = { tipoghost: 1, numpajaros: 2, bg: 'f4.jpg', txt: 'Neuschwanstein Castle ', fuel: 200, traptipo: 0, speed: 3 };
      levels[cont++] = { tipoghost: 0, numpajaros: 2, bg: 'f4.jpg', txt: 'Neuschwanstein Castle ', fuel: 200, traptipo: 0, speed: 3 };
      levels[cont++] = { tipoghost: 1, numpajaros: 2, bg: 'f5.jpg', txt: 'Statues of Easter Island', fuel: 200, traptipo: 1, speed: 3 };
      levels[cont++] = { tipoghost: 2, numpajaros: 2, bg: 'f5.jpg', txt: 'Statues of Easter Island', fuel: 200, traptipo: 0, speed: 3 };
      levels[cont++] = { tipoghost: 2, numpajaros: 2, bg: 'f6.jpg', txt: 'Stonehenge', fuel: 200, traptipo: 0, speed: 4 };
      levels[cont++] = { tipoghost: 1, numpajaros: 3, bg: 'f6.jpg', txt: 'Stonehenge', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 2, numpajaros: 3, bg: 'f7.jpg', txt: 'The Acropolis of Athens', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 2, numpajaros: 3, bg: 'f7.jpg', txt: 'The Acropolis of Athens', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 1, numpajaros: 3, bg: 'f8.jpg', txt: 'Eiffel Tower', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 3, numpajaros: 3, bg: 'f8.jpg', txt: 'Eiffel Tower', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 3, numpajaros: 3, bg: 'f9.jpg', txt: 'The Kremlin / Red Square', fuel: 200, traptipo: 1, speed: 4 };
      levels[cont++] = { tipoghost: 2, numpajaros: 3, bg: 'f9.jpg', txt: 'The Kremlin / Red Square', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 3, numpajaros: 3, bg: 'f10.jpg', txt: ' The Pyramids of Giza ', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 4, numpajaros: 3, bg: 'f10.jpg', txt: ' The Pyramids of Giza ', fuel: 200, traptipo: 1, speed: 5 };

      levels[cont++] = { tipoghost: 4, numpajaros: 4, bg: 'f11.jpg', txt: ' The Statue of Liberty', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 3, numpajaros: 4, bg: 'f11.jpg', txt: ' The Statue of Liberty', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 4, numpajaros: 4, bg: 'f12.jpg', txt: ' Timbuktu ', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 5, numpajaros: 4, bg: 'f12.jpg', txt: ' Timbuktu ', fuel: 200, traptipo: 1, speed: 5 };
      levels[cont++] = { tipoghost: 5, numpajaros: 4, bg: 'f13.jpg', txt: 'Petra Great Temple', fuel: 200, traptipo: 1, speed: 6 };
      levels[cont++] = { tipoghost: 4, numpajaros: 4, bg: 'f13.jpg', txt: 'Petra Great Temple', fuel: 200, traptipo: 1, speed: 6 };
      levels[cont++] = { tipoghost: 5, numpajaros: 4, bg: 'f14.jpg', txt: 'La Sagrada Familia', fuel: 200, traptipo: 1, speed: 6 };
      levels[cont++] = { tipoghost: 6, numpajaros: 4, bg: 'f14.jpg', txt: 'La Sagrada Familia', fuel: 200, traptipo: 1, speed: 6 };
      levels[cont++] = { tipoghost: 6, numpajaros: 4, bg: 'f15.jpg', txt: 'Machu Pichu', fuel: 200, traptipo: 1, speed: 6 };
      levels[cont++] = { tipoghost: 6, numpajaros: 4, bg: 'f15.jpg', txt: 'Machu Pichu (Final)', fuel: 200, traptipo: 1, speed: 6 };

      //min
      //levels[cont++] = {tipoghost:1, numpajaros:5, bg:'f1.jpg', txt: 'Paris', gravity: .001,  fuel: 200, trapmov: 1,gravinc:.04 };
      //max
      //levels[cont++] = {tipoghost:1, numpajaros:5, bg:'f1.jpg', txt: 'Paris', gravity: .03, rangey: 10, fuel: 100, trapmov: 1, gravinc: 1.2 };
      var pajaros;
      /*
      var pajaros = new Array(5)
      cont = 0;
      pajaros[cont++] = { xPos: 0, yPos: 0, dx: 0, dy: 0, w: 29, h: 24, incx: 0, incy: 0 }
      pajaros[cont++] = { xPos: 0, yPos: 0, dx: 0, dy: 0, w: 29, h: 24, incx: 0, incy: 0 }
      pajaros[cont++] = { xPos: 0, yPos: 0, dx: 0, dy: 0, w: 29, h: 24, incx: 0, incy: 0 }
      */
      var currentlevel = 0;

      var blank = new Image();
      var donde0 = new Image();
      var donde1 = new Image();
      var aghost0 = new Image();
      var aghost1 = new Image();
      var aghosta0 = new Image();
      var aghosta1 = new Image();
      var pajaro0 = new Image();
      var pajaro1 = new Image();
      var pajaro2 = new Image();
      var pajaro3 = new Image();
      var pajaro4 = new Image();
      var pajaro5 = new Image();
      var aplayer0 = new Image();
      var aplayer1 = new Image();
      var aplayerfin = new Image();
      var ef2 = new Image();

      var bola0 = new Image();
      var bola1 = new Image();
      var bola2 = new Image();
      var bola3 = new Image();
      var bola4 = new Image();
      var explo0 = new Image();
      var explo1 = new Image();
      var explo2 = new Image();
      var explo3 = new Image();
      var explo4 = new Image();
      var trapoff = new Image();
      var trapon0 = new Image();
      var trapon1 = new Image();
      var fondo = new Image();

      function xxx(id) {
      return document.getElementById(id);
      }
      function getanim(idx) {

      var img = anims[idx];

      if (img.cont++ > img.max) {
      img.cont = 0;
      if (img.current + 1 < img.numframes) {
                    img.current++
                }
                else if (img.numrepes == 0) {
                    img.current = 0;
                }
            }

            var imgdef = eval(img.src + img.current);

            if (imgdef != null)
                return imgdef
            else
                return blank;

        }
        function checktouching(item1, item2) {
            var midw1, midw2, midh1, midh2;
            midw1 = item1.w / 2;
            midw2 = item2.w / 2;
            midh1 = item1.h / 2;
            midh2 = item2.h / 2;

            var difX = (item1.xPos + midw1) - (item2.xPos + midw2) - 0; // -0 converts to integer
            var difY = (item1.yPos + midh1) - (item2.yPos + midh2) - 0; // -0 converts to integer

            difX = parseInt(difX)
            difY = parseInt(difY)

            // set touch = 1 if it is touching an enemy
            if (difX > (-1 * (midw1)) && difX < midw2 && difY > (-1 * midh1) && difY < midh2) {
                touch = 1;
            }
            else touch = 0;
            return touch
        }
        function initmenu() {
            $("#divloading").hide()
            if (getURLParam("l") == "")
                $("#divmenu").fadeIn("slow")
            else {
                $("#divmenu").fadeIn("slow")
                initgame();
            }

        }
        function initgame() {
        
            $("#divmenu").hide()
            $("#divloading").fadeIn("slow")
            ctx = document.getElementById('divcanvas').getContext('2d');
            ctxBG = document.getElementById('divcanvasBG').getContext('2d');
            
            
            gamestatus = 0
            /*
            lander = document.getElementById( 'divlander' );
            landerHeight = parseInt( lander.height );
            landerWidth = parseInt( lander.width );
            */
            //maximo 30 niveles

            if (currentlevel == "")
                currentlevel = 0;
            document.getElementById("divmsgs").innerHTML = "<img src='logo.png' /><h1>" + levels[currentlevel].txt + "</h1><br/><img src='logoimg.png' /><br /><img src='start.png'>"
            fuel = levels[currentlevel].fuel;

            pajaros = new Array(levels[currentlevel].numpajaros)
            var despx = canvasw / (pajaros.length + 1)
            for (var cont = 0; cont < pajaros.length; cont++) {
                pajaros[cont] = { xPos: despx * cont, yPos: canvash / 2, dx: 0, dy: 0, w: 35 * factorw, h: 35 * factorh, incx: 0, incy: 0 }
            }

            $("#divloading").hide()
            $("#divgameplay").fadeIn("slow");
            pause = true;
            
            startTimer();    // start the game

        }
        var maintimer = null;
        var filterStrength = 20;
        var frameTime = 0, lastLoop = new Date, thisLoop;
        var fondoPainted = false;
        function julkDrawImage(div,img,x,y,w,h) {
            
        }
        function paint() {

            var thisFrameTime = (thisLoop = new Date) - lastLoop;
            frameTime += (thisFrameTime - frameTime) / filterStrength;
            lastLoop = thisLoop;
            doAnimation()
	          if (!fondoPainted){
              
	            ctxBG.drawImage(fondo, 0, 0, canvasw, canvash);
		          fondoPainted=true;
	          }
        }
        function startTimer() {
            
            var fps = 40
            maintimer = setInterval(paint, 1000 / fps);
        }
        function getURLParam(strParamName) {
            var strReturn = "";
            var strHref = window.location.href;
            if (strHref.indexOf("?") > -1) {
                var strQueryString = strHref.substr(strHref.indexOf("?")).toLowerCase();
                var aQueryString = strQueryString.split("&");
                for (var iParam = 0; iParam < aQueryString.length; iParam++) {
                    if (aQueryString[iParam].indexOf(strParamName + "=") > -1) {
                        var aParam = aQueryString[iParam].split("=");
                        strReturn = aParam[1];
                        break;
                    }
                }
            }
            return strReturn;
        }
        function movepajaro(idx) {
            if (pajaros[idx].movesteps > 0) {
                pajaros[idx].xPos = pajaros[idx].xPos + pajaros[idx].incx;
                pajaros[idx].yPos = pajaros[idx].yPos + pajaros[idx].incy;
                pajaros[idx].movesteps--;
            }
            else {
                //alert(ghost.tox + "x-x" + ghost.toy)
                pajaros[idx].movesteps = 50 - currentlevel;
                pajaros[idx].toy = Math.ceil(Math.random() * (canvasw-50)) + 50;
                pajaros[idx].tox = Math.ceil(Math.random() * (canvash-70));
                var disty = pajaros[idx].toy - pajaros[idx].yPos;
                var distx = pajaros[idx].tox - pajaros[idx].xPos;
                var dist = Math.abs(distx) + Math.abs(disty)
                /*
                if (dist < 200)
                pajaros[idx].movesteps = 200
                if (dist < 150)
                pajaros[idx].movesteps = 100
                if (dist < 100)
                pajaros[idx].movesteps = 50
                if (dist < 50)
                pajaros[idx].movesteps = 20
                */

                pajaros[idx].movesteps = dist / levels[currentlevel].speed //(minimo 2;max:8)
                pajaros[idx].incx = parseInt(distx / pajaros[idx].movesteps)
                pajaros[idx].incy = parseInt(disty / pajaros[idx].movesteps)

            }
        }
        function movearrastrar() {
            if (ghost.movesteps > 0) {
                ghost.xPos = ghost.xPos + ghost.incx;
                ghost.yPos = ghost.yPos + ghost.incy;
                ghost.movesteps--;
            }
            else
                if (ghost.movesteps <= 0 && parseInt(mouse.x) != mouse.antx && parseInt(mouse.y) != mouse.anty) {
                //alert(ghost.tox + "x-x" + ghost.toy)                
                if (mouse.y > canvash - rangey)
                    mouse.y = canvash - rangey;
                var disty = mouse.y - (ghost.yPos + (ghost.h / 2));
                var distx = mouse.x - (ghost.xPos + (ghost.w / 2));

                var dist = Math.abs(distx) + Math.abs(disty)
                ghost.movesteps = parseInt(dist / levels[currentlevel].speed) //(minimo 2;max:8)
                ghost.incx = distx / ghost.movesteps
                ghost.incy = disty / ghost.movesteps
            }
            //$("debugOutput").innerHTML=mouse.x + "-" + mouse.y + "+" + ghost.incx + "-" + ghost.incy
        }

        function move() {
            if (ghost.movesteps >= 0) {
                ghost.xPos = ghost.xPos + ghost.incx;
                ghost.yPos = ghost.yPos + ghost.incy;
                ghost.movesteps--;
            }
            else {
                //alert(ghost.tox + "x-x" + ghost.toy)

                ghost.toy = Math.ceil(Math.random() * 250);
                ghost.tox = Math.ceil(Math.random() * 250);
                var disty = ghost.toy - ghost.yPos;
                var distx = ghost.tox - ghost.xPos;
                var dist = Math.abs(distx) + Math.abs(disty)

                ghost.movesteps = dist / (levels[currentlevel].speed * 7.5) //(minimo 2;max:8)
                ghost.incx = parseInt(distx / ghost.movesteps)
                ghost.incy = parseInt(disty / ghost.movesteps)
            }
        }
        function move2() {
            if (ghost.movesteps >= 0) {
                ghost.xPos = ghost.xPos + ghost.incx;
                ghost.yPos = ghost.yPos + ghost.incy;
                document.getElementById("debugOutput").innerHTML = "<H1>GOTCHA!!</H1>";
                ghost.movesteps--;
            }
            else {

                document.getElementById("debugOutput").innerHTML = "INFO:Drive the ghost at the trap by tapping on screen<BR/><font style='color:red'>Don't touch the birds</font>";
                gamestatus = 1;
                mouse.x = canvasw - ghost.w;
                mouse.y = 0;
            }
        }
        function resetmove2() {
            ghost.movesteps = 35;
            ghost.toy = 20;
            ghost.tox = canvasw - ghost.w - 20;
            var disty = ghost.toy - ghost.yPos;
            var distx = ghost.tox - ghost.xPos;

            ghost.incx = parseInt(distx / ghost.movesteps)
            ghost.incy = parseInt(disty / ghost.movesteps)

        }
        function rayo2(ctx) {
            if (mouse.x < canvasw && mouse.y < canvash) {
                var r1xold, r1yold;
                var desp1 = Math.round(30 * Math.random())
                var desp2 = Math.round(5 * Math.random())
                r1xold = mouse.x;
                //r1yold=canvash/2
                r1yold = mouse.y - 15 + desp1;
                //r2yold=0;                       
                ctx.beginPath();
                ctx.moveTo(r1xold, r1yold);
                ctx.lineTo(canvasw / 2 + desp2, canvash - ghost.h - 3);
                ctx.lineWidth = 25 * ratiow;
                //ctx.endPath();
                ctx.stroke();
            }
        }
        function rayo(ctx) {
            if (mouse.x < canvasw && mouse.y < canvash) {
                var r1xold, r1yold;
                ctx.lineWidth = 25 * ratiow;
                r1xold = ghost.xPos + (ghost.w / 2);
                //r1yold=canvash/2
                r1yold = ghost.yPos + (ghost.h / 2);
                //r2yold=0;

                var pasoy = Math.round(Math.abs((ghost.yPos - (canvash - ghost.h - 3))) / 20);

                var pasox = 10;
                ctx.beginPath();
                ctx.moveTo(r1xold, r1yold);
                for (i = 0; i < 18; i++) {
                    var xrandom = Math.round(pasox * Math.random());

                    var newx = r1xold + xrandom;
                    if (r1xold + xrandom > ghost.xPos)
                        newx = r1xold - xrandom

                    ctx.lineTo(newx, r1yold + pasoy);
                    //ctx.arcTo(r1xold,r1yold,newx,r1yold+pasoy,10);
                    //$("txt2").innerHTML=(newx+"*"+(r1yold+yrandom))

                    r1xold = newx;
                    r1yold = r1yold + pasoy

                }

                //ctx.lineTo(canvasw, canvash - ghost.h - 3);
                //ctx.endPath();
                ctx.stroke();
            }
        }

        function testclick() {
            if (contclick >= 1)
                if (mouse.x < ghost.xPos + ghost.w && mouse.x > ghost.xPos) {
                if (mouse.y < ghost.yPos + ghost.h && mouse.y > ghost.yPos) {
                    gamestatus = 5;
                    resetmove2();
                }
            }
            if (contclick <= 0) {
                mouse.x = canvasw - ghost.w;
                mouse.y = 0;
            }

        }
        function rayos() {
            ctx.strokeStyle = "#ff9933";
            rayo(ctx);
            ctx.strokeStyle = "#ffffff";
            rayo(ctx);
            ctx.strokeStyle = "#ffcc00";
            rayo(ctx);
            rayoesfera()
        }
        function rayoesfera() {
//            ctx.shadowBlur = 3;
//            ctx.shadowColor = "white";
            if (bswitch == 0) {
                ctx.fillStyle = "#ff9933";
                bswitch = 1;
                ctx.strokeStyle = "#ffffff";
            }
            else {
                ctx.fillStyle = "#ffcc00";
                bswitch = 0;
                ctx.strokeStyle = "#ff9933";
            }
            ctx.beginPath();
            ctx.arc(ghost.xPos, canvash - ghost.h - 10, 15, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.stroke();
            ctx.fill();
        }
        function rayos2() {

            ctx.strokeStyle = "#ff9933";
            rayo2(ctx);
            ctx.strokeStyle = "#ffffff";
            rayo2(ctx);
            ctx.strokeStyle = "#ffcc00";
            rayo2(ctx);

        }
        function timeoutgameover() {
            $("#divgameplay").hide()
            $("#divgameover").fadeIn("slow")
            clearTimeout(timeraux)
            gamestatus = 666;
        }
        function timeoutnextlevel() {
            $("#divgameplay").hide()
            $("#divnextlevel").fadeIn("slow")
            clearTimeout(timeraux)
            gamestatus = 666;

        }
        function ira(donde){
	    	  window.location.href=donde
        }
        function gotonext() {
            $("#divloading").fadeIn("slow");
            $("#divnextlevel").hide()
            
            if (currentlevel < levels.length - 1)
                window.setTimeout(function () {ira('?l=' + (parseInt(currentlevel) + 1))},clockspeed*10);
            else {
                $("#divgamefinished").fadeIn("slow")
                $("#divgameplay").hide()
                $("#divnextlevel").hide()

            }

        }
        function gotosavedlevel() {
            $("#divmenu").hide()
            $("#divloading").fadeIn("slow")
            window.setTimeout(function () {ira('?l=' + (parseInt(getCookie("ghostlevel")) + 1))},clockspeed*10);            
        }
        function btstart() {
            $("#divmenu").hide()
            $("#divloading").fadeIn("slow")
            
            window.setTimeout(function () {ira('?l=0')},clockspeed*10);
        }
        function btgameover() {
            $("#divgameover").hide()
            $("#divloading").fadeIn("slow")
            if (getCookie("ghostlevel")!="")
            window.setTimeout(function () {ira('?l=' + (parseInt(currentlevel)))},clockspeed*10);            
            else
            window.setTimeout(function () {ira('?l=0')},clockspeed*10);            
            
        }
        function bttryagain() {
            $("#divgamefinished").hide()
            $("#divloading").fadeIn("slow")            
            window.setTimeout(function () {ira('/')},clockspeed*10);            
        }
        function doAnimation() {
            ticker.paint();
            if (waiting) return;
            if (fuel <= 0) {
              $("#divgameplay").hide()
              $("#divgameover").fadeIn("slow")
              return
              }
              ctx.clearRect(0, 0, canvasw, canvash);

              /*
              var gradient = ctx.createLinearGradient(0, 0, 0, 16);
              gradient.addColorStop(0, "#999999");
              gradient.addColorStop(1, "#999966");
              ctx.fillStyle = gradient;
              */
              ctx.fillStyle = "#999966";
              ctx.strokeStyle = "#000000";
              ctx.fillRect(0, canvash - 40, canvasw, 40);

              var fueltpc = (fuel * canvasw) / levels[currentlevel].fuel

              //            ctx.shadowBlur = 10;
              //            ctx.shadowColor = "white";
              // Fill the path
              ctx.fillStyle = "#000000";
              ctx.fillRect(2, 2, canvasw , 40);
              /*
              gradient = ctx.createLinearGradient(0, 0, 0, 16);
              gradient.addColorStop(0, "#ffc821");
              gradient.addColorStop(1, "#ff0000");
              ctx.fillStyle = gradient;
              */
              ctx.fillStyle = "#ff0000";
              ctx.fillRect(2, 2, fueltpc, 40);
              ctx.lineWidth = 3;
              if (pause != true) {
              if (gamestatus == 0) {              
              //fuel = fuel - currentlevel / 30
              fuel = fuel - (levels[currentlevel].speed/20)
              move();
              ctx.drawImage(getanim(0), ghost.xPos, ghost.yPos, ghost.w, ghost.h);
              ctx.drawImage(getanim(2), (canvasw / 2) - (ghost.w / 2), canvash - ghost.h - 3, ghost.w, ghost.h);
              //window.setTimeout(doAnimation, 50);
              //window.setTimeout(doAnimation, clockspeed);
              testclick();
              if (contclick-- >= 1) {
              rayos2();
              if (currentlevel<10)
                            fuel = fuel - 10
                        else
                            fuel = fuel - 5
                    }
                }
                else if (gamestatus == 1) {
                    fuel = fuel - currentlevel / 70
                    /*                
                    ghost.dy += gravity;
                    ghost.xPos += ghost.dx;
                    ghost.yPos += ghost.dy;
                    */
                    /*
                    if (levels[currentlevel].traptipo != 0) {
                    
                    trap.xPos = trap.xPos + trap.despx
                    if (trap.xPos+(trap.w/2) < 5) trap.despx = 1;
                    if (trap.xPos + (trap.w / 2) > canvasw - 5) trap.despx = -1;
                    }
                    */
                    if (levels[currentlevel].traptipo != 0) {
                        if (trap.contestado-- <= 0) {
                            if (trap.estado == 1) {
                                trap.estado = 0;
                                trap.contestado = 100 + (Math.ceil(Math.random() * currentlevel) * 3)
                            }
                            else {
                                trap.estado = 1;
                                trap.contestado = 100 - (Math.ceil(Math.random() * currentlevel) * 3)
                            }
                        }
                    }
                    //$("debugOutput").innerHTML = trap.contestado + "|" + trap.estado
                    movearrastrar()

                    if (trap.estado == 0)
                        ctx.drawImage(trapoff, trap.xPos, trap.yPos, trap.w, trap.h);
                    else
                        ctx.drawImage(getanim(7), trap.xPos, trap.yPos, trap.w, trap.h);
                    ctx.drawImage(getanim(1), ghost.xPos, ghost.yPos, ghost.w, ghost.h);
                    ctx.drawImage(getanim(2), ghost.xPos - (ghost.w / 2), canvash - ghost.h - 3, ghost.w, ghost.h);
                    //ctx.drawImage(getanim(3), ghost.xPos - (ghost.w / 2), canvash - ghost.h - 30, ghost.w, ghost.h);

                    if (ghost.movesteps > 0)
                        ctx.drawImage(getanim(5), mouse.x - 10, mouse.y - 10, 20, 20);
                    for (var i = 0; i < pajaros.length; i++) {
                        movepajaro(i);
                        if (checktouching(ghost, pajaros[i]) == 1) {
                            gamestatus = 9
                        }
                        ctx.drawImage(getanim(6), pajaros[i].xPos, pajaros[i].yPos, pajaros[i].w, pajaros[i].h);
                    }

                    //ctx.drawImage(getanim(2), ghost.xPos, ghost.yPos, 40, 40);
                    rayos()
                    if (trap.estado == 1 && ghost.yPos + ghost.h > trap.yPos && ghost.xPos + ghost.w >= trap.xPos && ghost.xPos <= trap.xPos + trap.w) {
                        gamestatus = 2;
                        document.getElementById("debugOutput").innerHTML = "<h1>STAGE CLEAR!!</h1>";
                    }
                    //window.setTimeout(function(){doAnimation()}, clockspeed);

                }
                if (gamestatus == 2) {
                    if (ghost.xPos > (trap.xPos + trap.w / 2)) ghost.xPos--
                    if (ghost.xPos < (trap.xPos + trap.w / 2)) ghost.xPos++
                    if (ghost.w > 8) ghost.w = ghost.w - 0.25
                    if (ghost.h > 8) ghost.h = ghost.h - 0.25
                    if (ghost.yPos + ghost.h < canvash - 5) {
                        ghost.yPos++
                    }
                    ctx.drawImage(getanim(7), trap.xPos, trap.yPos, trap.w, trap.h);
                    ctx.drawImage(getanim(1), ghost.xPos, ghost.yPos, ghost.w, ghost.h);
                    ctx.drawImage(getanim(2), ghost.xPos - (ghost.w / 2), canvash - trap.h - 3, trap.w, trap.h);
                    if (timeraux == null)
                        timeraux = setTimeout(function() { timeoutnextlevel() }, 3000);
                    window.setTimeout(doAnimation, clockspeed);
                }
                /*
                if (gamestatus == 3) {
                if (ghost.yPos > -30) {
                ghost.yPos = ghost.yPos - 3;
                }
                else {
                gamestatus = 7;
                }
                ctx.drawImage(getanim(1), ghost.xPos, ghost.yPos, ghost.w, ghost.h);
                window.setTimeout(doAnimation, 50);
                if (timeraux == null)
                timeraux=setTimeout(function() { timeoutnextlevel() }, 3000);
                }
                */
                if (gamestatus == 5) {
                    move2();
                    ctx.drawImage(getanim(1), ghost.xPos, ghost.yPos, ghost.w, ghost.h);
                    ctx.drawImage(getanim(2), ghost.xPos - (ghost.w / 2), canvash - ghost.h - 3, ghost.w, ghost.h);
                    //window.setTimeout(doAnimation, clockspeed);
                    rayos();

                }
                if (gamestatus == 8) {
                    ctx.fillStyle = "#000000";
                    var with2 = 290;
                    ctx.fillRect(0, 0, 300, 20);
                    ctx.fillStyle = "#ff0000";
                    var margenerror = 20;
                    var margen1, margen2
                    margen1 = (with2 / 2) - (margenerror / 2)
                    margen2 = (with2 / 2) + (margenerror / 2)
                    ctx.fillRect(5, 2, margen1, 16);
                    ctx.fillStyle = "#00ff00";
                    ctx.fillRect(margen1, 2, margenerror, 16);
                    ctx.fillStyle = "#ff0000";
                    ctx.fillRect(margen2, 2, with2 - margen2, 16);
                    if (breaklockx < 4) breaklockdesp = 10;
                    if (breaklockx > 285) breaklockdesp = -10;
                    breaklockx = breaklockx + breaklockdesp
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(breaklockx, 2, 10, 10);
                    //window.setTimeout(doAnimation, clockspeed*2);
                }
                if (gamestatus == 9) {
                    document.getElementById("debugOutput").innerHTML = "OVERLOAD!!OVERLOAD!!";
                    ctx.drawImage(aplayerfin, ghost.xPos, canvash - ghost.h, ghost.w, ghost.h);
                    var explo = getanim(4)
                    ctx.drawImage(explo, ghost.xPos - (ghost.w / 2), canvash - ghost.h - 3, ghost.w * 2, ghost.h * 2);
                    ctx.drawImage(explo, ghost.xPos, ghost.yPos, ghost.w * 2, ghost.h * 2);

                    //ctx.drawImage(getanim(1), ghost.xPos - (ghost.w / 2), canvash - ghost.h - 3, ghost.w, ghost.h);
                    //window.setTimeout(doAnimation, clockspeed*2);
                    if (timeraux == null)
                        timeraux = setTimeout(function() { timeoutgameover() }, 3000);
                }
            }
            else {

                $("#divmsgs").fadeIn("slow")
                $("#divcanvas").hide()
                $("#divcanvasBG").hide()
                /*
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.font = "bold 14px 'Times New Roman', Times, serif";            
                ctx.fillStyle = "#ffcc00";
                ctx.fillRect(0, 80, 300, 200);
                
                ctx.fillStyle = "#000";
                ctx.strokeStyle = "#f00";
                
                try {
                ctx.fillText(msg, 10, 90);
                } catch (ex) {alert(ex) }                

                */


            }
            //document.getElementById("debugOutput").innerHTML = "<h1>STAGE CLEAR!!</h1>";
        }
        $(document).ready(function() {
            
            var fpsOut = document.getElementById('fps');            
            setInterval(function() {
                fpsOut.innerHTML = (1000 / frameTime).toFixed(1) + " fps";                
            }, 1000); 
            initmenu();
            $(window).resize();
            
        });
        $(window).resize(function() {
        
            //alert(ratiow + "-" + ratioh);
            ratiow = Math.min(1, $(window).width() / canvasw);
            ratioh = Math.min(1, $(window).height() / canvash);

            ratiow = Math.min(ratiow, ratioh);
            ratioh = Math.min(0.6, ratioh);
            //alert(ratioh)
            //ctx.scale(ratiow, ratioh)
            document.getElementById("divcanvas").style.width = (canvasw*ratiow) + "px";
            //document.getElementById("divcanvas").style.height = (canvash * ratioh) + "px";
            document.getElementById("divcanvasBG").style.width = (canvasw * ratiow) + "px";
            //document.getElementById("divcanvasBG").style.height = (canvash * ratioh) + "px";
            ctxBG.drawImage(fondo, 0, 0, canvasw, canvash);
            //alert(ratiow + "-" + ratioh);
            $('.bigDiv').css({
                position: 'absolute',
                left: 0,
                top: 0
            });

        });
    </script>
  
</head>

<body>
    <div  id="divloading" class="bigDiv">
        <img src="logo.png" /><br />
        <img src="logoimg.png" /><br />
        <img src="loading.gif" width="100" />
    </div>    
    <div id="divmenu"  class="bigDiv" style="display:none">
        <img src="logo.png" /><br />
        <img src="logoimg.png" /><br />
        <img src="start.png"  onclick="btstart();this.blur()"/><br />
        
        <script>
            if (parseInt(getCookie("ghostlevel"))) {
                document.writeln('<img src="continue.png" onclick="gotosavedlevel();this.blur()" />')
                document.writeln("<p align=center>Last Level:" + getCookie("ghostlevel") + "</p>")
            }
        </script>
        
    </div>    
    <div id="divmsgs" class="bigDiv"></div>
    <div id="divgameplay" style="display:none;">    
            
        <canvas id="divcanvas" style="position:absolute;top:0px;left:0px;z-index:1" width="720" height="960"></canvas>   
        <canvas id="divcanvasBG" style="position:absolute;top:0px;left:0px;z-index:0" width="720" height="960"></canvas>   
    	<div id="debugOutput" style="position:absolute;bottom:20px;left:0px;background-color:gray"></div>     
           
    </div>    
    <div id="divgameover" class="bigDiv"  style="display:none" >
        <img src="logo.png" /><br />
        <img src="logoimg.png" /><br />
        <img src="gameover.png" /><br />
        <img src="tryagain.png" onclick="btgameover();" />
    </div> 
    <div id="divgamefinished"  class="bigDiv" style="display:none">
        <img src="logo.png" /><br />
        <img src="logoimg.png" /><br />
        <img src="gamefinished.png" /><br />
        <img src="tryagain.png"  onclick="bttryagain();" />
    </div>       
    <div id="divnextlevel"  class="bigDiv"  style="display:none">
        <img src="logo.png" /><br />
        <img src="logoimg.png" /><br />
        <img src="stageclear.png" /><br />
        <img src="ok.png"  onclick="gotonext()" />
    </div>
  <div id="tickerBg" style="position:absolute;background-color:blue;height:40px;display:none;z-index:666">
    &nbsp;
  </div>
  <div id="tickerMsg" style="background-color:none;position:absolute;height:40px;text-align:left;color:white;display:none;z-index:667">
    &nbsp;
  </div>
    <div id="fps" style="position:absolute;top:0px;left:0px;text-align:center;color:yellow;z-index:4;">
    </div>
    <script>

      if (typeof (document.body.ontouchstart) == "undefined") {
      document.getElementById("divcanvas").onmousedown = function(e) {
                e.preventDefault();
                mouse.antx = mouse.x
                mouse.anty = mouse.y
                mouse.x = e.pageX / ratiow;
                mouse.y = e.pageY / ratiow;
                if (mouse.x < 30 && mouse.y < 30)
                    waiting = !waiting;
                if (gamestatus != 5)
                    ghost.movesteps = 0;
                if (gamestatus == 0) {
                    contclick = 2;
                }
                if (ticker.status == 2) 
                    ticker.contador = 1;

            }
            document.getElementById("divmsgs").onmousedown = function(e) {

                if (pause == true) {
                    pause = false;
                    $("#divmsgs").hide();
                    $("#divcanvas").fadeIn("slow");
                    $("#divcanvasBG").fadeIn("slow");
                    waiting=true;                    
                    ticker.msg.push("Go!!!");
                    ticker.msg.push("Ready??");
                    ticker.callback = function () {
                        waiting=false;
                    }
                    
                    ticker.activate();
                    document.getElementById("debugOutput").innerHTML = "Info:Tap above the ghost to catch him...";
                    doAnimation()
                }
            }

        } else {

            document.getElementById("divcanvas").ontouchstart = function(e) {                                                  
                e.preventDefault();
                mouse.antx = mouse.x
                mouse.anty = mouse.y
                mouse.x = e.touches[0].pageX / ratiow;
                mouse.y = e.touches[0].pageY / ratiow;
                if (mouse.x < 30 && mouse.y < 30)
                    waiting = !waiting;
                if (gamestatus != 5)
                    ghost.movesteps = 0;
                if (gamestatus == 0) {
                    contclick = 2;
                }
                if (ticker.status == 2) 
                    ticker.contador = 1;

            }
            document.getElementById("divmsgs").ontouchstart = function(e) {
                e.preventDefault();
                if (pause == true) {
                    pause = false;
                    $("#divmsgs").hide();
                    $("#divcanvas").fadeIn("slow");
                    $("#divcanvasBG").fadeIn("slow");
                    waiting=true;                    
                    ticker.msg.push("Go!!!");
                    ticker.msg.push("Ready??");
                    ticker.callback = function () {
                        waiting=false;
                    }
                    
                    ticker.activate();
                    document.getElementById("debugOutput").innerHTML = "Info:Tap above the ghost to catch him...";
                    doAnimation()
                }
            }
        }
        //cargo imagenes antes, por si las moscas
        currentlevel = getURLParam("l")
        if (currentlevel == "" || currentlevel == "NaN") currentlevel = 0;
        blank.src = "blank.png";
        donde0.src = "donde0.png";
        donde1.src = "donde1.png";
        aghost0.src = "ghost" + levels[currentlevel].tipoghost + "0.png";
        aghost1.src = "ghost" + levels[currentlevel].tipoghost + "1.png";
        aghosta0.src = "ghost" + levels[currentlevel].tipoghost + "a0.png";
        aghosta1.src = "ghost" + levels[currentlevel].tipoghost + "a1.png";
        pajaro0.src = "pajaro0.png";
        pajaro1.src = "pajaro1.png";
        pajaro2.src = "pajaro2.png";
        pajaro3.src = "pajaro3.png";
        pajaro4.src = "pajaro4.png";
        pajaro5.src = "pajaro5.png";
        aplayer0.src = "player0.png";
        aplayer1.src = "player1.png";
        aplayerfin.src = "player2.png";
        ef2.src = "ef2.png";
        bola0.src = "bolarayo0.png";
        bola1.src = "bolarayo1.png";
        bola2.src = "bolarayo2.png";
        bola3.src = "bolarayo3.png";
        bola4.src = "bolarayo4.png";
        explo0.src = "explo0.png";
        explo1.src = "explo1.png";
        explo2.src = "explo2.png";
        explo3.src = "explo3.png";
        explo4.src = "explo4.png";
        explo4.src = "blank.png";
        trapoff.src = "trapoff0.png";
        trapon0.src = "trapon0.png";
        trapon1.src = "trapon1.png";
        fondo.src = levels[currentlevel].bg;
        
        ML.soundssrcs.push("bgm|fase1.ogg|loop")
        //ML.soundssrcs.push("fx1|bell1.ogg")
        ML.loadAll();
        function loadSoundsFinished() {           
          ML.sounds["bgm"].play();     
        }
    </script>

</body>
</html>
